{% extends 'base.html' %}
{% load static %}
{% block title %}Artículos y Noticias - Descubre Curicó{% endblock %}
 
{% block content %}
<div class="bg-white">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
 
    <!-- Encabezado y Acciones -->
    <div class="border-b border-gray-200 pb-5 mb-8 sm:flex sm:items-center sm:justify-between">
      <div>
        <h1 class="text-3xl font-bold leading-tight text-gray-900">Contenido</h1>
        <p class="mt-1 text-sm text-gray-500">Gestiona artículos, noticias y reportajes.</p>
      </div>
      {% if es_admin %}
      <div class="mt-4 sm:mt-0 sm:ml-4 flex-shrink-0">
        <div x-data="{ open: false }" @keydown.escape.stop="open = false" @click.away="open = false" class="relative inline-block text-left">
          <button @click="open = !open" type="button" class="inline-flex items-center gap-x-2 rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
            Crear Nuevo
            <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg>
          </button>
          <div x-show="open" x-transition:enter="transition ease-out duration-100" x-transition:enter-start="transform opacity-0 scale-95" x-transition:enter-end="transform opacity-100 scale-100" x-transition:leave="transition ease-in duration-75" x-transition:leave-start="transform opacity-100 scale-100" x-transition:leave-end="transform opacity-0 scale-95" class="absolute right-0 z-10 mt-2 w-56 origin-top-right rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none" style="display: none;">
            <div class="py-1">
              <a href="{% url 'appadmincontenido:articulo_crear' 'articulo' %}" class="text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100">Artículo</a>
              <a href="{% url 'appadmincontenido:articulo_crear' 'noticia' %}" class="text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100">Noticia</a>
              <a href="{% url 'appadmincontenido:articulo_crear' 'reportaje' %}" class="text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100">Reportaje</a>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
 
    <!-- Filtros -->
    <form method="get" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-8 max-w-3xl mx-auto" id="filterForm">
      <div>
        <label for="tipoFilter" class="block text-sm font-medium text-gray-700">Tipo</label>
        <select name="tipo" id="tipoFilter" class="mt-1 block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 text-base focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm">
          <option value="">Todos</option>
          <option value="articulo" {% if tipo_filter == 'articulo' %}selected{% endif %}>Artículos</option>
          <option value="noticia" {% if tipo_filter == 'noticia' %}selected{% endif %}>Noticias</option>
          <option value="reportaje" {% if tipo_filter == 'reportaje' %}selected{% endif %}>Reportajes</option>
        </select>
      </div>
      <div>
        <label for="categoriaFilter" class="block text-sm font-medium text-gray-700">Categoría</label>
        <select name="categoria" id="categoriaFilter" class="mt-1 block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 text-base focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm">
          <option value="">Todas</option>
          {% for cat in categorias %}
            <option value="{{ cat.slug }}" {% if categoria_filter == cat.slug %}selected{% endif %}>{{ cat.nombre }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="flex items-end">
        <a href="{% url 'appadmincontenido:articulos' %}" class="w-full text-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">Limpiar</a>
      </div>
    </form>
 
    <!-- Grid de artículos -->
    <div class="grid gap-8 sm:grid-cols-2 lg:grid-cols-3" id="articleGrid">
      {% for a in page_obj %}
        <div class="flex flex-col overflow-hidden rounded-lg shadow-lg transition-shadow hover:shadow-xl article-card" data-type="{{ a.get_type|lower }}" data-categories="{% for c in a.categorias.all %}{{ c.slug }} {% endfor %}">
          <div class="flex-shrink-0">
            <a href="{{ a.get_absolute_url }}">
              {% if a.portada %}
                <img class="h-48 w-full object-cover" src="{{ a.portada.url }}" alt="{{ a.titulo }}">
              {% else %}
                <div class="h-48 w-full bg-gray-200"></div>
              {% endif %}
            </a>
          </div>
          <div class="flex flex-1 flex-col justify-between bg-white p-6">
            <div class="flex-1">
              <p class="text-sm font-medium" style="color: {% if a.get_type == 'Articulo' %}#3D5A40{% elif a.get_type == 'Noticia' %}#CC1E70{% else %}#6A8F61{% endif %};">
                {{ a.get_type }}
                {% if a.estado == 'DRAFT' %}<span class="ml-2 text-amber-600">(Borrador)</span>{% endif %}
              </p>
              <a href="{{ a.get_absolute_url }}" class="mt-2 block">
                <p class="text-xl font-semibold text-gray-900 line-clamp-2">{{ a.titulo }}</p>
                <p class="mt-3 text-sm text-gray-500 line-clamp-3">{{ a.resumen }}</p>
              </a>
            </div>
            <div class="mt-6 flex items-center justify-between">
              <div class="flex items-center text-sm text-gray-500">
                <svg class="h-5 w-5 text-gray-400 mr-1.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.75 2a.75.75 0 01.75.75V4h7V2.75a.75.75 0 011.5 0V4h.25A2.75 2.75 0 0118 6.75v8.5A2.75 2.75 0 0115.25 18H4.75A2.75 2.75 0 012 15.25v-8.5A2.75 2.75 0 014.75 4H5V2.75A.75.75 0 015.75 2zm-1 5.5c0-.414.336-.75.75-.75h10.5a.75.75 0 010 1.5H5.5a.75.75 0 01-.75-.75z" clip-rule="evenodd" /></svg>
                <time datetime="{{ a.publicado_en|date:'Y-m-d' }}">{{ a.publicado_en|date:"d M, Y" }}</time>
              </div>
              <!-- Categorías -->
              <div class="flex flex-wrap gap-1 justify-end items-center">
                {% with total_categorias=a.categorias.all|length %}
                  {% if total_categorias > 1 %}
                    {% for c in a.categorias.all|slice:":1" %}
                      <span class="inline-flex items-center rounded-md bg-gray-50 px-2 py-1 text-xs font-medium text-gray-600 ring-1 ring-inset ring-gray-500/10">{{ c.nombre|truncatechars:15 }}</span>
                    {% endfor %}
                    <div class="relative group">
                      <span class="inline-flex items-center rounded-md bg-gray-100 px-2 py-1 text-xs font-medium text-gray-600 ring-1 ring-inset ring-gray-500/10 cursor-pointer">+{{ total_categorias|add:"-1" }}</span>
                      <div class="absolute bottom-full right-0 mb-2 w-48 p-2 bg-gray-800 text-white text-xs rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10">
                        <ul class="space-y-1">{% for c in a.categorias.all|slice:"1:" %}<li>- {{ c.nombre }}</li>{% endfor %}</ul>
                      </div>
                    </div>
                  {% else %}
                    {% for c in a.categorias.all %}
                      <span class="inline-flex items-center rounded-md bg-gray-50 px-2 py-1 text-xs font-medium text-gray-600 ring-1 ring-inset ring-gray-500/10">{{ c.nombre|truncatechars:15 }}</span>
                    {% endfor %}
                  {% endif %}
                {% endwith %}
              </div>
              {% if es_admin %}
              <div x-data="{ open: false }" @keydown.escape.stop="open = false" @click.away="open = false" class="relative">
                <button @click="open = !open" class="rounded-full p-1.5 text-gray-500 hover:bg-gray-100">
                  <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M3 10a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0zM8.5 10a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0zM15.5 8.5a1.5 1.5 0 100 3 1.5 1.5 0 000-3z" /></svg>
                </button>
                <div x-show="open" x-transition class="absolute right-0 bottom-8 z-10 mt-2 w-32 origin-top-right rounded-md bg-white py-1 shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none" style="display: none;">
                  <a href="{% url 'appadmincontenido:articulo_editar' a.slug a.get_type|lower %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Editar</a>
                  <a href="{% url 'appadmincontenido:articulo_eliminar' a.slug a.get_type|lower %}" class="block px-4 py-2 text-sm text-red-700 hover:bg-red-50">Eliminar</a>
                </div>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      {% empty %}
        <div class="col-span-full py-12 text-center">
          <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" /></svg>
          <h3 class="mt-2 text-sm font-semibold text-gray-900">Sin contenido</h3>
          <p class="mt-1 text-sm text-gray-500">Empieza creando un nuevo artículo, noticia o reportaje.</p>
        </div>
      {% endfor %}
    </div>
 
    <!-- Paginación -->
    {% if page_obj.paginator.num_pages > 1 %}
    <nav class="flex items-center justify-between border-t border-gray-200 px-4 sm:px-0 mt-12">
      <div class="-mt-px flex w-0 flex-1">
        {% if page_obj.has_previous %}
          <a href="?page={{ page_obj.previous_page_number }}{% if tipo_filter %}&tipo={{ tipo_filter }}{% endif %}{% if categoria_filter %}&categoria={{ categoria_filter }}{% endif %}" class="inline-flex items-center border-t-2 border-transparent pr-1 pt-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700">
            <svg class="mr-3 h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a.75.75 0 01-.75.75H4.66l2.1 1.95a.75.75 0 11-1.02 1.1l-3.5-3.25a.75.75 0 010-1.1l3.5-3.25a.75.75 0 111.02 1.1l-2.1 1.95h12.59A.75.75 0 0118 10z" clip-rule="evenodd" /></svg>
            Anterior
          </a>
        {% endif %}
      </div>
      <div class="hidden md:-mt-px md:flex">
        {% for n in page_obj.paginator.page_range %}
          {% if n == page_obj.number %}
            <span class="inline-flex items-center border-t-2 border-indigo-500 px-4 pt-4 text-sm font-medium text-indigo-600">{{ n }}</span>
          {% else %}
            <a href="?page={{ n }}{% if tipo_filter %}&tipo={{ tipo_filter }}{% endif %}{% if categoria_filter %}&categoria={{ categoria_filter }}{% endif %}" class="inline-flex items-center border-t-2 border-transparent px-4 pt-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700">{{ n }}</a>
          {% endif %}
        {% endfor %}
      </div>
      <div class="-mt-px flex w-0 flex-1 justify-end">
        {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}{% if tipo_filter %}&tipo={{ tipo_filter }}{% endif %}{% if categoria_filter %}&categoria={{ categoria_filter }}{% endif %}" class="inline-flex items-center border-t-2 border-transparent pl-1 pt-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700">
            Siguiente
            <svg class="ml-3 h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M2 10a.75.75 0 01.75-.75h12.59l-2.1-1.95a.75.75 0 111.02-1.1l3.5 3.25a.75.75 0 010 1.1l-3.5 3.25a.75.75 0 11-1.02-1.1l2.1-1.95H2.75A.75.75 0 012 10z" clip-rule="evenodd" /></svg>
          </a>
        {% endif %}
      </div>
    </nav>
    {% endif %}
 
  </div>
</div>
 
<!-- Alpine.js para los menús desplegables -->
<script src="//unpkg.com/alpinejs" defer></script>
 
<script>
document.addEventListener('DOMContentLoaded', function() {
  const tipoFilter = document.getElementById('tipoFilter');
  const categoriaFilter = document.getElementById('categoriaFilter');
  const articleGrid = document.getElementById('articleGrid');
  const articleCards = articleGrid.querySelectorAll('.article-card');
  let noResultsMessage = null;

  function applyFilters() {
    const tipo = tipoFilter.value.toLowerCase();
    const categoria = categoriaFilter.value.toLowerCase();
    let visibleCount = 0;

    articleCards.forEach(card => {
      const cardType = card.dataset.type.toLowerCase();
      const cardCategories = card.dataset.categories.toLowerCase();
      
      const typeMatch = !tipo || cardType === tipo;
      const categoryMatch = !categoria || cardCategories.includes(categoria);
      
      if (typeMatch && categoryMatch) {
        card.style.display = 'flex';
        visibleCount++;
      } else {
        card.style.display = 'none';
      }
    });

    // Manejar mensaje de "no hay resultados"
    const emptyMessage = articleGrid.querySelector('.empty-message');
    if (visibleCount === 0 && !emptyMessage) {
      articleGrid.insertAdjacentHTML('beforeend', '<div class="col-span-full py-12 text-center empty-message"><p class="text-gray-500">No hay contenido que coincida con los filtros.</p></div>');
    } else if (visibleCount > 0 && emptyMessage) {
      emptyMessage.remove();
    }
  }

  tipoFilter.addEventListener('change', applyFilters);
  categoriaFilter.addEventListener('change', applyFilters);
});
</script>
{% endblock %}
